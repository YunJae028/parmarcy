<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<html>
    <header>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="/css/mapstyle.css" rel="stylesheet">
        <title>ì§€ë„ ì°¾ê¸°</title>
    </header>

    <%@ include file="header.jsp" %>
    <body>
        <div class="map-area">
            <button class="openbtn" onclick="openNav()">ğŸ’Š Open List</button>
            <div class="list-area" style="left:0px; position: absolute;">
                <div id="mySidebar" class="sidebar">
                    <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">Ã—</a>
                        <div id="list"></div>
                </div>
            </div>
            <select name="searchOption">
                <option value="">ê²€ìƒ‰ì˜µì…˜</option>
                <option value="place">ìœ„ì¹˜</option>
                <option value="drug">ì•½í’ˆëª…</option>
            </select>
            <input id="place" />
            <button id="search" style="position: absolute;right: 20px; margin-top: 100px;">ê²€ìƒ‰</button>
            <button id="currentSearch" style="position: absolute;right: 86px; margin-top: 100px;">í˜„ì¬ ìœ„ì¹˜ì—ì„œ ê²€ìƒ‰</button>
            <div id="map" style="position: relative; width: 1550px;height: 700px;margin-left: 350px;"></div>
        </div>

        <div class="background">
          <div class="window">
            <div class="popup">
              <button id="closePop">Ã—</button>
              <div id="drugList">

              </div>
            </div>
            <div>
              <div></div>
            </div>
          </div>
        </div>

    </body>

    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=0eec856fe65fd0106ad48250e458cae0&libraries=services"></script>

  <script>
        var mapContainer = document.getElementById('map'), // ì§€ë„ë¥¼ í‘œì‹œí•  div
        mapOption = {
            center: new kakao.maps.LatLng(37.686040837930676, 127.04676347327286), // ì§€ë„ì˜ ì¤‘ì‹¬ì¢Œí‘œ
            level: 1 // ì§€ë„ì˜ í™•ëŒ€ ë ˆë²¨
        };

        var map = new kakao.maps.Map(mapContainer, mapOption); // ì§€ë„ë¥¼ ìƒì„±í•©ë‹ˆë‹¤

        var bounds = null; // í˜„ì¬ ìœ„ì¹˜
        var markers = [];
        var infoWindows = [];

        // í˜„ì¬ ìœ„ì¹˜ ì´ìš©í•˜ì—¬ ì•½êµ­ ê²€ìƒ‰
        if (navigator.geolocation) {
            // GeoLocationì„ ì´ìš©í•´ì„œ ì ‘ì† ìœ„ì¹˜ë¥¼ ì–»ì–´ì˜µë‹ˆë‹¤
            navigator.geolocation.getCurrentPosition(function(position) {

                var lat = position.coords.latitude, // ìœ„ë„
                    lon = position.coords.longitude; // ê²½ë„

                var coords = new kakao.maps.LatLng(lat, lon);

                // ì§€ë„ì˜ ì¤‘ì‹¬ì„ ê²°ê³¼ê°’ìœ¼ë¡œ ë°›ì€ ìœ„ì¹˜ë¡œ ì´ë™ì‹œí‚µë‹ˆë‹¤
                map.setCenter(coords);

                bounds = map.getBounds();
                var center = map.getCenter();

                // ì˜ì—­ì˜ ë‚¨ì„œìª½ ì¢Œí‘œë¥¼ ì–»ì–´ì˜µë‹ˆë‹¤
                var swLatLng = bounds.getSouthWest();
                console.log('ë‚¨ì„œìª½ : ', swLatLng);

                // ì˜ì—­ì˜ ë¶ë™ìª½ ì¢Œí‘œë¥¼ ì–»ì–´ì˜µë‹ˆë‹¤
                var neLatLng = bounds.getNorthEast();
                console.log('ë¶ë™ìª½ : ', neLatLng);
                console.log('ë¶ë™ìª½ Lat : ', neLatLng.getLat());
                console.log('ë¶ë™ìª½ Lng : ', neLatLng.getLng());

                // ì˜ì—­ì •ë³´ë¥¼ ë¬¸ìì—´ë¡œ ì–»ì–´ì˜µë‹ˆë‹¤. ((ë‚¨,ì„œ), (ë¶,ë™)) í˜•ì‹ì…ë‹ˆë‹¤
                var boundsStr = bounds.toString();
                console.log('ì˜ì—­ì •ë³´ ë¬¸ìì—´ : ', boundsStr);

                var params = {
                    currentLat : lat,
                    currentLon : lon,
                    swLat : swLatLng.getLat(),
                    swLng : swLatLng.getLng(),
                    neLat : neLatLng.getLat(),
                    neLng : neLatLng.getLng()
                }

                // í˜„ì¬ ìœ„ì¹˜ì—ì„œ ì•½êµ­ ê²€ìƒ‰
                $.ajax({
                url:"/pharmacyList",
                type:"GET",
                dataType:"json",
                data : params,
                success:function (data){
                    console.log('ajax :', data);
                    //ë§ˆì»¤ í‘œì‹œ
                     searchMarkerInfo(data);
                     $.each(data, function (index, item){
                         $("#list").append("<ul>"+item.dutyName + "</ul>");
                         $("#list").append("<ul>"+item.dutyAddr+"</ul>");
                         $("#list").append("<ul>"+item.dutyTel1+"</ul>");
                     });
                }
            });

        });
        } else {
                var params = {
                    currentLat :  37.500501354129156,
                    currentLon : 126.86761643487512
                }

                // í˜„ì¬ ìœ„ì¹˜ì—ì„œ ì•½êµ­ ê²€ìƒ‰
                $.ajax({
                url:"/pharmacyList",
                type:"GET",
                dataType:"json",
                data : params,
                success:function (data){
                    console.log('ajax :', data);
                    //ë§ˆì»¤ í‘œì‹œ
                     searchMarkerInfo(data);
                     $.each(data, function (index, item){
                         $("#list").append("<ul>"+item.dutyName + "</ul>");
                         $("#list").append("<ul>"+item.dutyAddr+"</ul>");
                         $("#list").append("<ul>"+item.dutyTel1+"</ul>");
                     });
                }
            });
        }

    // ì•½í’ˆìœ¼ë¡œ ê²€ìƒ‰ -> ê´€ë¦¬ì êµ¬í˜„ í›„ ê°€ëŠ¥

    function closeOverlay() {
        for (var i=0;i<infoWindows.length;i++) {
            infoWindows[i].setMap(null);
        }
    }

    function searchMarkerInfo(list){
        $.each(list, function (index, item){
            var checkOpen = item.checkopen;

            if(checkOpen == '0'){
                 imageSrc = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZlcnNpb249IjEuMSIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHhtbG5zOnN2Z2pzPSJodHRwOi8vc3ZnanMuY29tL3N2Z2pzIiB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgeD0iMCIgeT0iMCIgdmlld0JveD0iMCAwIDUxMiA1MTIiIHN0eWxlPSJlbmFibGUtYmFja2dyb3VuZDpuZXcgMCAwIDUxMiA1MTIiIHhtbDpzcGFjZT0icHJlc2VydmUiIGNsYXNzPSIiPjxnPgo8ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgoJPGc+CgkJPHBhdGggZD0iTTI1NiwwQzE1My43NTUsMCw3MC41NzMsODMuMTgyLDcwLjU3MywxODUuNDI2YzAsMTI2Ljg4OCwxNjUuOTM5LDMxMy4xNjcsMTczLjAwNCwzMjEuMDM1ICAgIGM2LjYzNiw3LjM5MSwxOC4yMjIsNy4zNzgsMjQuODQ2LDBjNy4wNjUtNy44NjgsMTczLjAwNC0xOTQuMTQ3LDE3My4wMDQtMzIxLjAzNUM0NDEuNDI1LDgzLjE4MiwzNTguMjQ0LDAsMjU2LDB6IE0yNTYsMjc4LjcxOSAgICBjLTUxLjQ0MiwwLTkzLjI5Mi00MS44NTEtOTMuMjkyLTkzLjI5M1MyMDQuNTU5LDkyLjEzNCwyNTYsOTIuMTM0czkzLjI5MSw0MS44NTEsOTMuMjkxLDkzLjI5M1MzMDcuNDQxLDI3OC43MTksMjU2LDI3OC43MTl6IiBmaWxsPSIjZmYwMDAwIiBkYXRhLW9yaWdpbmFsPSIjMDAwMDAwIiBzdHlsZT0iIiBjbGFzcz0iIj48L3BhdGg+Cgk8L2c+CjwvZz4KPGcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPC9nPgo8ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8L2c+CjxnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjwvZz4KPGcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPC9nPgo8ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8L2c+CjxnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjwvZz4KPGcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPC9nPgo8ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8L2c+CjxnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjwvZz4KPGcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPC9nPgo8ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8L2c+CjxnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjwvZz4KPGcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPC9nPgo8ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8L2c+CjxnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjwvZz4KPC9nPjwvc3ZnPg=="
               var status = 'ìš´ì˜ ì¢…ë£Œ';
            } else {
                imageSrc = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZlcnNpb249IjEuMSIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHhtbG5zOnN2Z2pzPSJodHRwOi8vc3ZnanMuY29tL3N2Z2pzIiB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgeD0iMCIgeT0iMCIgdmlld0JveD0iMCAwIDUxMiA1MTIiIHN0eWxlPSJlbmFibGUtYmFja2dyb3VuZDpuZXcgMCAwIDUxMiA1MTIiIHhtbDpzcGFjZT0icHJlc2VydmUiIGNsYXNzPSIiPjxnPgo8ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgoJPGc+CgkJPHBhdGggZD0iTTI1NiwwQzE1My43NTUsMCw3MC41NzMsODMuMTgyLDcwLjU3MywxODUuNDI2YzAsMTI2Ljg4OCwxNjUuOTM5LDMxMy4xNjcsMTczLjAwNCwzMjEuMDM1ICAgIGM2LjYzNiw3LjM5MSwxOC4yMjIsNy4zNzgsMjQuODQ2LDBjNy4wNjUtNy44NjgsMTczLjAwNC0xOTQuMTQ3LDE3My4wMDQtMzIxLjAzNUM0NDEuNDI1LDgzLjE4MiwzNTguMjQ0LDAsMjU2LDB6IE0yNTYsMjc4LjcxOSAgICBjLTUxLjQ0MiwwLTkzLjI5Mi00MS44NTEtOTMuMjkyLTkzLjI5M1MyMDQuNTU5LDkyLjEzNCwyNTYsOTIuMTM0czkzLjI5MSw0MS44NTEsOTMuMjkxLDkzLjI5M1MzMDcuNDQxLDI3OC43MTksMjU2LDI3OC43MTl6IiBmaWxsPSIjMDA4NWZiIiBkYXRhLW9yaWdpbmFsPSIjMDAwMDAwIiBzdHlsZT0iIiBjbGFzcz0iIj48L3BhdGg+Cgk8L2c+CjwvZz4KPGcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPC9nPgo8ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8L2c+CjxnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjwvZz4KPGcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPC9nPgo8ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8L2c+CjxnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjwvZz4KPGcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPC9nPgo8ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8L2c+CjxnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjwvZz4KPGcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPC9nPgo8ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8L2c+CjxnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjwvZz4KPGcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPC9nPgo8ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8L2c+CjxnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjwvZz4KPC9nPjwvc3ZnPg=="
                var status = 'ìš´ì˜ ì¤‘';
            }
            imageSize = new kakao.maps.Size(50, 55);
            imageOption = {offset: new kakao.maps.Point(27, 69)};

            var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imageOption)
            var markerPosition = new kakao.maps.LatLng(item.wgs84Lat,item.wgs84Lon);

            var marker = new kakao.maps.Marker({
                position: markerPosition,
                image : markerImage,
                text : item.dutyName,
            });

            getInfoWindow(marker,item);

            marker.setMap(map);


            // ìƒì„±ëœ ë§ˆì»¤ë¥¼ ë°°ì—´ì— ì¶”ê°€í•©ë‹ˆë‹¤
            markers.push(marker);
        });
    }

    function getInfoWindow(marker,item){
        var content = '<div class="wrap">' +
            '    <div class="info">' +
            '        <div class="title">' +
            '            '+item.dutyName+'' +
            '            <div class="close" onclick="closeOverlay()" title="ë‹«ê¸°"></div>' +
            '        </div>' +
            '        <div class="body">' +
            '                <div class="ellipsis"> '+ item.dutyAddr+ '</div>' +
            '                <div class="jibun ellipsis">'+ item.dutyTel1+ '</div>' +
            '                <div class="jibun ellipsis">'+ status + '</div>' +
            '        </div>' +
            '    </div>' +
            '</div>';

        var infoWindow = new kakao.maps.CustomOverlay({
            content: content,
            position: marker.getPosition()
        });
        infoWindows.push(infoWindow);

        // ë§ˆì»¤ë¥¼ í´ë¦­í–ˆì„ ë•Œ ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤
        kakao.maps.event.addListener(marker, 'click', function() {
            // All infowindow close
            closeOverlay();

            // infoWindow.open(map,marker);
            infoWindow.setMap(map);
        });
    }

    // ë°°ì—´ì— ì¶”ê°€ëœ ë§ˆì»¤ë“¤ì„ ì§€ë„ì— í‘œì‹œí•˜ê±°ë‚˜ ì‚­ì œí•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤
    function setMarkers(map) {
        for (var i = 0; i < markers.length; i++) {
            markers[i].setMap(map);
        }
    }

    $('#search').on('click',function () {
        $("#list").empty();
        setMarkers(null);

        // ì£¼ì†Œë¥¼ ë°›ì•„ì„œ ê²€ìƒ‰
        // ì£¼ì†Œ-ì¢Œí‘œ ë³€í™˜ ê°ì²´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
        var geocoder = new kakao.maps.services.Geocoder();

        var address = $('#place').val();

        // ì£¼ì†Œ ìˆìœ¼ë©´ í•´ë‹¹ ì£¼ì†Œë¡œ ê²€ìƒ‰
        if (address != null && address != '') {
            // ì£¼ì†Œë¡œ ì¢Œí‘œë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤
            geocoder.addressSearch(address, function (result, status) {
                // ì •ìƒì ìœ¼ë¡œ ê²€ìƒ‰ì´ ì™„ë£Œëìœ¼ë©´
                if (status === kakao.maps.services.Status.OK) {
                    var coords = new kakao.maps.LatLng(result[0].y, result[0].x);

                    // ì§€ë„ì˜ ì¤‘ì‹¬ì„ ê²°ê³¼ê°’ìœ¼ë¡œ ë°›ì€ ìœ„ì¹˜ë¡œ ì´ë™ì‹œí‚µë‹ˆë‹¤
                    // map.setCenter(coords);
                    searchPharmacy(coords);
                }
            });
        }
    });

     $('#currentSearch').on('click',function () {
        $("#list").empty();
         setMarkers(null);

        searchPharmacy();
     });

     $('#dutyAddr').on('click', function (){


     });

    function searchPharmacy(coords) {

        if (coords != null && coords != '') {
            map.setCenter(coords);
        }

        bounds = map.getBounds();

        // ì˜ì—­ì˜ ë‚¨ì„œìª½ ì¢Œí‘œë¥¼ ì–»ì–´ì˜µë‹ˆë‹¤
        var swLatLng = bounds.getSouthWest();
        console.log('ë‚¨ì„œìª½ : ', swLatLng);

        // ì˜ì—­ì˜ ë¶ë™ìª½ ì¢Œí‘œë¥¼ ì–»ì–´ì˜µë‹ˆë‹¤
        var neLatLng = bounds.getNorthEast();

        // ì˜ì—­ì •ë³´ë¥¼ ë¬¸ìì—´ë¡œ ì–»ì–´ì˜µë‹ˆë‹¤. ((ë‚¨,ì„œ), (ë¶,ë™)) í˜•ì‹ì…ë‹ˆë‹¤
        var boundsStr = bounds.toString();
        console.log('ì˜ì—­ì •ë³´ ë¬¸ìì—´ : ', boundsStr);

        var params = {
            searchOption : $("#searchOption option:selected").val(),
            swLat: swLatLng.getLat(),
            swLng: swLatLng.getLng(),
            neLat: neLatLng.getLat(),
            neLng: neLatLng.getLng()
        }

        // í˜„ì¬ ìœ„ì¹˜ì—ì„œ ì•½êµ­ ê²€ìƒ‰
        $.ajax({
            url: "/pharmacyList",
            type: "GET",
            dataType: "json",
            data: params,
            success: function (data) {
                //ë§ˆì»¤ í‘œì‹œ
                searchMarkerInfo(data);
                $.each(data, function (index, item) {
                    if(item.checkopen == '0'){
                        var checkOpen = 'ìš´ì˜ì¢…ë£Œ ğŸ˜';
                    } else {var checkOpen = 'ìš´ì˜ì¤‘ ğŸ˜Š';}
                    var hpid = item.hpid;
                    var dutyName =  'dutyName' + index;
                    var dutyAddr =  'dutyAddr' + index;
                    var dutyTel = 'dutyTel' + index;
                    var checkOpenId =  'checkOpen' + index;
                    var dutyInventory =  'dutyInventory' + index;
                    $("#list").append("<ul id=\"" +  dutyName + "\" class='dutyName'>" + item.dutyName + "</ul>");
                    $("#list").append("<ul id=\"" +  dutyAddr + "\" class='dutyAddr'>" + item.dutyAddr + "</ul>");
                    $("#list").append("<ul id=\"" +  dutyTel + "\" class='dutyTel'>" + item.dutyTel1 + "</ul>");
                    $("#list").append("<ul id=\"" +  checkOpenId + "\" class='checkOpen'>" + checkOpen + "</ul>");
                    $("#list").append("<button id=\"" +  dutyInventory + "\" class='dutyInventory'>"+"ì•½í’ˆì¬ê³ "+"</button>");
                    document.getElementById(dutyInventory).addEventListener("click", function() {
                        inventoryPop(hpid);
                    }, false);
                });
            }
        });
    }

</script>

<script>
function openNav() {
  document.getElementById("mySidebar").style.width = "350px";
  document.getElementById("map").style.marginLeft = "350px";
}

function closeNav() {
  document.getElementById("mySidebar").style.width = "0";
  document.getElementById("map").style.marginLeft= "0px";
}

function inventoryPop(srchHpid){

    show();

        var params = {
            hpid : srchHpid
        };

        // ì•½í’ˆ ì¬ê³  ë¦¬ìŠ¤íŠ¸ í™•ì¸
        $.ajax({
            url: "/drugList",
            type: "GET",
            dataType: "json",
            data: params,
            success: function (data) {
                // $.each(data, function (index, item) {
                //
                // });

            }
        });
}

  function show() {
    document.querySelector(".background").className = "background show";
  }

  function closePop() {
    document.querySelector(".background").className = "background";
  }

  document.querySelector("#closePop").addEventListener("click", closePop);
</script>

</html>